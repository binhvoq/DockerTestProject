---
description: # Technical Details & Troubleshooting Guide
globs: 
alwaysApply: false
---
# Technical Details & Troubleshooting Guide

## Container Architecture

### Docker Environment:
- **Base Image**: `python:3.10-slim` 
- **System Dependencies**: ffmpeg, wget, curl, git
- **Python Dependencies**: Xem [DockerProject/requirements.txt](mdc:DockerProject/requirements.txt)
- **Working Directory**: `/app/`
- **Volume Mounts**: 
  - `./output:/app/output` (bidirectional)
  - `./subjects.txt:/app/subjects.txt` (read-only)

### Environment Variables:
- **OPENAI_API_KEY**: Required cho content generation vÃ  keyword extraction
- **PYTHONUNBUFFERED=1**: Äá»ƒ real-time logging
- **DEBIAN_FRONTEND=noninteractive**: TrÃ¡nh hang during apt install

## Pipeline Data Flow

### File System Layout trong Container:
```
/app/
â”œâ”€â”€ subjects.txt          # Input (mounted)
â”œâ”€â”€ temp/                 # Temporary processing files
â”‚   â”œâ”€â”€ content.txt       # Generated content tá»« OpenAI
â”‚   â”œâ”€â”€ plan.txt          # Video plan mapping
â”‚   â”œâ”€â”€ plan/             # Individual script files
â”‚   â”œâ”€â”€ current_script.txt # Script Ä‘ang Ä‘Æ°á»£c process
â”‚   â”œâ”€â”€ keywords.txt      # Generated keywords
â”‚   â”œâ”€â”€ my_audio/         # Generated audio files
â”‚   â”œâ”€â”€ my_images/        # Downloaded/placeholder images
â”‚   â””â”€â”€ final_video.mp4   # Temp video output
â””â”€â”€ output/               # Final output (mounted)
    â”œâ”€â”€ plan.txt          # Final plan file
    â””â”€â”€ my_result/        # Final video files
```

### Processing States:
1. **Content Generation**: `subjects.txt` â†’ `temp/content.txt`
2. **Plan Creation**: `temp/content.txt` â†’ `temp/plan.txt` + `temp/plan/*.txt`
3. **Per-Video Processing**:
   - Load script â†’ `temp/current_script.txt`
   - Generate audio â†’ `temp/my_audio/output_*.wav`
   - Generate keywords â†’ `temp/keywords.txt`
   - Download images â†’ `temp/my_images/output_*.jpg`
   - Combine â†’ `temp/final_video.mp4`
   - Move â†’ `output/my_result/[sanitized_title].mp4`

## Key Technical Decisions

### Text-to-Speech (TTS):
- **Primary**: Google TTS (gTTS) - free, decent quality, multi-language
- **Fallback**: Demo audio generation - synthetic tones náº¿u gTTS fail
- **Chunking**: Split long text thÃ nh chunks â‰¤200 chars Ä‘á»ƒ trÃ¡nh TTS limits
- **Audio Format**: WAV 24kHz (compatible vá»›i FFmpeg)

### Image Processing:
- **Source**: Google Images via icrawler
- **Fallback**: Placeholder images vá»›i colored backgrounds + text overlay
- **Processing**: Resize + crop vá» 1280x720 (16:9 aspect ratio)
- **Format**: JPEG quality 90% Ä‘á»ƒ balance size vs quality

### Video Generation:
- **Method**: FFmpeg static image + audio combination
- **Settings**: 
  - Video: libx264, CRF 23, 30fps, yuv420p
  - Audio: AAC, 192kbps
- **Concatenation**: Individual clips â†’ final video via FFmpeg concat

## Common Issues & Solutions

### 1. OpenAI API Errors
**Symptoms**: Content generation fails
**Causes**: 
- Invalid API key
- Rate limiting
- Model khÃ´ng available (gpt-4.1-nano â†’ gpt-4.1-mini fallback)

**Solutions**:
```bash
# Check API key
echo $OPENAI_API_KEY

# Test API connectivity  
curl -H "Authorization: Bearer $OPENAI_API_KEY" \
  https://api.openai.com/v1/models
```

### 2. Image Download Failures
**Symptoms**: Chá»‰ cÃ³ placeholder images
**Causes**:
- Google Images blocking/rate limiting
- Network connectivity issues
- Invalid search keywords

**Debug**: Check logs cho "âŒ Error downloading image"
**Solution**: Placeholder system tá»± Ä‘á»™ng kick in

### 3. FFmpeg Processing Errors
**Symptoms**: Video generation fails, no output files
**Common Causes**:
- Missing audio/image files
- Corrupted media files
- Insufficient disk space

**Debug Commands**:
```bash
# Check FFmpeg installation
ffmpeg -version

# Test basic functionality
ffprobe input_file.wav
```

### 4. Memory/Performance Issues
**Symptoms**: Container OOM, slow processing
**Solutions**:
- Increase Docker memory limit
- Monitor vá»›i `docker stats`
- Implement batch processing limits

### 5. Volume Mount Issues
**Symptoms**: No output files, permission errors
**Debug**:
```bash
# Check mount points
docker run --rm -v "$(pwd)/output:/app/output" \
  video-generation-pipeline ls -la /app/output

# Check permissions
ls -la output/
```

## Debugging Strategies

### 1. Container Inspection:
```bash
# Run interactive shell
docker run -it --rm \
  -v "$(pwd)/output:/app/output" \
  -v "$(pwd)/subjects.txt:/app/subjects.txt" \
  -e OPENAI_API_KEY="$OPENAI_API_KEY" \
  video-generation-pipeline /bin/bash

# Check running processes
docker exec -it [container_id] ps aux
```

### 2. Log Analysis:
- Look for emoji indicators: âœ… success, âŒ error, âš ï¸ warning
- Check step-by-step progress: ğŸ“, ğŸ“‹, ğŸ¥, ğŸ”¹
- Monitor resource usage: ğŸ“Š, ğŸ“, ğŸ“„

### 3. Incremental Testing:
```bash
# Test individual components
python generate_content.py
python create_plan.py  
python audio_generator.py
```

## Performance Optimization

### 1. Container Resources:
```bash
# Run vá»›i memory limit
docker run --memory=4g --rm \
  -v "$(pwd)/output:/app/output" \...

# Monitor resource usage
docker stats
```

### 2. Parallel Processing:
- Hiá»‡n táº¡i: Sequential video processing
- Future: Implement concurrent video generation
- Bottleneck: OpenAI API rate limits

### 3. Caching Strategies:
- Cache generated content based on subject hash
- Cache downloaded images
- Reuse audio files cho identical text

## Integration Notes

### Vá»›i OldProject Upload System:
- **plan.txt format**: `title | script_filename`
- **Video naming**: Sanitized titles â†’ valid filenames
- **File structure**: Compatible vá»›i [OldProject/upload/uploadTuDongYoutube.py](mdc:OldProject/upload/uploadTuDongYoutube.py)

### API Rate Limits:
- **OpenAI**: Depends on plan (gpt-4o-mini has higher limits)
- **Google Images**: Implicit rate limiting, handled by icrawler
- **gTTS**: Free tier cÃ³ daily limits

### Scaling Considerations:
- **Horizontal**: Multiple containers cho different subject sets  
- **Vertical**: Increase container resources
- **Storage**: Implement cleanup strategies cho temp files
- **Monitoring**: Add health checks vÃ  metrics collection

